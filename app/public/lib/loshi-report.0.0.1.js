!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.LoshiReport=e()}(this,function(){"use strict";var t=(new Date).getTime(),e={beginTime:t,loadTime:0,ajaxTime:0,fetchTime:0};Object.defineProperty(e,"beginTime",{value:t,writable:!1,configurable:!1});var n=null,r={reportApi:"http://localhost:7001/api",outtime:1e3,filterUrl:["http://localhost:35729/livereload.js?snipver=1","http://localhost:8000/sockjs-node/info"],isPage:!0,isResource:!0,isError:!0};function o(t){var e=r;return t&&(e=r[t]),e}function i(t){return"[object Function]"===function(t){return Object.prototype.toString.call(t)}(t)}function a(t){return Object.assign({appId:n,time:(new Date).getTime(),page:window.location.href,preUrl:document.referrer&&document.referrer!==window.location.href?document.referrer:"",appVersion:navigator.appVersion,screenwidth:document.documentElement.clientWidth||document.body.clientWidth,screenheight:document.documentElement.clientHeight||document.body.clientHeight},t)}var c={t:"",n:"js",msg:"",data:{}};function u(t){return Object.assign({},c,{t:(new Date).getTime(),method:"GET"},t)}var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},d=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},f=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();function h(t){return Object.assign({},c,{t:(new Date).getTime(),n:"ajax",msg:t.statusText||"ajax request error",method:t.method,data:{resourceUrl:t.responseURL,text:t.statusText,status:t.status,payload:t.xhr.body}})}var l=Object.assign({},{errorList:[],fetchNum:0,loadNum:0,ajaxLength:0,fetLength:0,ajaxMsg:[],goingType:"",haveAjax:!1,haveFetch:!1,hadInitReport:!1,reportingInitData:!1});function p(){var t=e.loadTime,n=e.ajaxTime,r=e.fetchTime;l.haveAjax&&l.haveFetch&&t&&n&&r||l.haveAjax&&!l.haveFetch&&t&&n||!l.haveAjax&&l.haveFetch&&t&&r||!l.haveAjax&&l.haveFetch}function g(t,e){window.fetch&&t&&(e&&(l.reportingInitData=!0),window.fetch(o().reportApi,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},type:"report-data",body:JSON.stringify(t)}).then(function(){}).finally(function(){e&&(l.hadInitReport=!0,l.reportingInitData=!1)}))}function m(t,e){l.reportingInitData||l.hadInitReport?t&&t():e&&e()}function w(t){l.loadNum+=1,l.loadNum===l.ajaxLength&&(l.ajaxLength=l.loadNum=0,e.ajaxTime=(new Date).getTime()-e.beginTime,p())}function y(t){if(l.ajaxMsg&&l.ajaxMsg.length)for(var e=0,n=l.ajaxMsg.length;e<n;e++)l.ajaxMsg[e].url===t.name&&(t.method=l.ajaxMsg[e].method||"GET",t.type=l.ajaxMsg[e].type||t.type)}function v(t){m(function(){g(a({errorList:[t]}))},function(){l.errorList.push(t)})}function x(){e.loadTime=(new Date).getTime()-e.beginTime,p();var t=Object.assign({},l);setTimeout(function(){l=Object.assign({},{errorList:[],fetchNum:0,loadNum:0,ajaxLength:0,fetLength:0,ajaxMsg:[],goingType:"",haveAjax:!1,haveFetch:!1,hadInitReport:!1,reportingInitData:!1},{hadInitReport:l.hadInitReport}),g(a({errorList:t.errorList,performance:o("isPage")?function(){if(window.performance){var t=window.performance.timing;return{dnst:t.domainLookupEnd-t.domainLookupStart||0,tcpt:t.connectEnd-t.connectStart||0,wit:t.responseStart-t.navigationStart||0,domt:t.domContentLoadedEventEnd-t.navigationStart||0,lodt:t.loadEventEnd-t.navigationStart||0,radt:t.fetchStart-t.navigationStart||0,rdit:t.redirectEnd-t.redirectStart||0,uodt:t.unloadEventEnd-t.unloadEventStart||0,reqt:t.responseEnd-t.requestStart||0,andt:t.domComplete-t.domInteractive||0}}}():null,resourceList:o("isResource")?function(t){if(window.performance||window.performance.getEntries)return(window.performance.getEntriesByType("resource")||[]).map(function(e){var n={name:e.name,method:"GET",type:e.initiatorType,duration:e.duration.toFixed(2)||0,decodedBodySize:e.decodedBodySize||0,nextHopProtocol:e.nextHopProtocol};return i(t)&&t(n),n})}(y):null}),!0)},o("outtime"))}return new(function(){function t(){d(this,t)}return f(t,[{key:"init",value:function(t,e){var c;Object.defineProperty(window,"LoshiReport",{value:this,configurable:!1,writable:!1}),Object.freeze(window.LoshiReport),Object.freeze(window.LoshiReport.__proto__),function(t){if(t&&t.appId)n=t.appId,delete t.appId;else{var e=Array.from(document.getElementsByTagName("script")),r=new RegExp(/loshi-report.*?js/),o=e.find(function(t){return r.test(t.getAttribute("src"))});o&&(n=o.getAttribute("src").split("?")[1])}}(t),(c=t)&&Object.assign(r,c),function(t,e){i(e)&&t&&window.addEventListener("load",e,!1)}(!0,x),function(t,e){i(e)&&t&&(window.addEventListener("error",function(t){if(t.target!==window){var n=u({n:"resource",msg:t.target.localName+" is load error",data:{target:t.target.localName,type:t.type,resourceUrl:t.target.currentSrc}});e(n)}},!0),window.onerror=function(t,n,r,o,i){var a=u({col:o||window.event&&window.event.errorCharacter||0,msg:i&&i.stack?i.stack.toString():t,data:{resourceUrl:n,line:r,col:o}});setTimeout(function(){return e(a)},0)})}(o().isError,v),function(t,e){if(t&&e)return window._ahrealxhr=window._ahrealxhr||window.XMLHttpRequest,window.XMLHttpRequest=function(){for(var t in this.xhr=new window._ahrealxhr,this.xhr){var e="";try{e=s(this.xhr[t])}catch(t){}"function"===e?this[t]=o(t):Object.defineProperty(this,t,{get:n(t),set:r(t)})}},window._ahrealxhr;function n(t){return function(){return this.hasOwnProperty(t+"_")?this[t+"_"]:this.xhr[t]}}function r(t){return function(n){var r=this.xhr,o=this;0==t.indexOf("on")?e[t]?r[t]=function(){e[t](o)||n.apply(r,arguments)}:r[t]=n:this[t+"_"]=n}}function o(t){return function(){var n=[].slice.call(arguments);if(!e[t]||!e[t].call(this,n,this.xhr))return this.xhr[t].apply(this.xhr,n)}}}(o().isError,function(){function t(t){m(function(){g(a({errorList:[h(t)]}))},function(){l.errorList.push(h(t))})}return{onreadystatechange:function(e){4===e.readyState&&setTimeout(function(){"load"!==l.goingType&&(l.goingType="readychange",m(null,function(){w()}),(e.status<200||e.status>300)&&(e.method=e.args.method,t(e)))},600)},onerror:function(e){m(null,function(){w()}),e.args&&(e.method=e.args.method,e.responseURL=e.args.url,e.statusText="ajax request error"),t(e)},onload:function(e){if(4===e.readyState){if("readychange"===l.goingType)return;l.goingType="load",m(null,function(){w()}),(e.status<200||e.status>300)&&(e.method=e.args.method,t(e))}},send:function(t,e){var n={};t&&t.length&&t[0]&&t[0].split("&").forEach(function(t){var e=t.split("=");n[e[0]]=e[1]||""}),e.body=n},open:function(t,e){var n=o().filterUrl;if(n&&n.length){var r=!1;if(n.forEach(function(e){-1!==t[1].indexOf(e)&&(r=!0)}),r)return}var i={url:t[1],method:t[0]||"GET",type:"xmlhttprequest"};this.args=i,m(null,function(){l.ajaxMsg.push(i),l.ajaxLength=l.ajaxLength+1,l.haveAjax=!0})}}}())}}]),t}())});
